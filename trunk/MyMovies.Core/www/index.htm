<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>My movies</title>
        <script type="text/javascript" src="jquery-1.6.1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="common.css"/>
        <link rel="stylesheet" type="text/css" href="themes/dark/style.css"/>
    </head>
    <body>
		<div class="sitecontainer">
			<div class="movies"></div>
			<div id="templates">
				<div class="movieclassic">
					<img class="cover" />
					<div class="content">
						<div class="title"></div>
						<div class="principals"></div>
						<div class="genres"></div>
						<div class="plot"></div>
						<span class="star hidden"></span>
						<a class="play">Play</a>
						<a class="showfiles"></a>
						<div class="files hidden"></div>
					</div>
                    <div class="clear"></div>
				</div>
			</div>
		</div>
        <script type="text/javascript">
            $(function () {
				$.fn.m = function(){
					var e = this;
					while(e.length){
						var d = e.data('m');
						if(d)return d;
						e = e.parent();
					}
				};
				
				var play = function(f){
					return $.get(base + '/*play', { f: f });
				};
				
				//live events
				$('.movies .showfiles').live('click', function(){
					var e = $(this);
					var div = $('.files', e.parent());
					var files = e.m().Files;
					if(div.is(':empty')){
						$.each(files, function(i,v){
							$('<a/>').text(v).click(function(){
								play(v);
							}).appendTo(div);
						});
					}
					div.slideToggle(Math.min(500, files.length * 20));
				});
				$('.movies .play').live('click', function () {
					play($(this).m().Files[0]);
				});
				
				//Usefull to test/edit layout
				var base = window.location.href.indexOf('file://') === 0
					? 'http://localhost:8080' : '';
                $.getJSON(base + '/*movies?jsonp=?', function (o) {
                    var template = $('#templates .movieclassic').clone();
					var t1 = $.now();
					var div = $('.movies');
                    for(var i in o) {
                        var m = o[i];
                        var e = template.clone().data('m', m);
                        $('.cover', e).attr('src', base + '/*scale/300x/' + (m.Cover ? 'covers/' + m.Cover : 'img/nocover.jpg'));
                        $('.title', e).text(m.Title + (m.Year ? ' - ' + m.Year : ''));
						$('.principals', e).text(m.Principals.join(' - '));
						$('.genres', e).text(m.Genres.join(' - '));
						$('.plot', e).text(m.Plot);
						if(m.ImdbRating)
							$('.star', e).removeClass('hidden').text(m.ImdbRating);
						$('.showfiles', e).text(m.Files.length + ' file' + (m.Files.length > 1 ? 's':''))
						
                        div.append(e);
                    }
					console.log('rendered ' + o.length + ' elements in ' + ($.now() - t1) + 'ms');
                });
            });
        </script>
    </body>
</html>
