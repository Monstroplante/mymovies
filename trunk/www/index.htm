<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>My movies</title>
        <script type="text/javascript" src="jquery-1.6.4.min.js"></script>
        <link rel="stylesheet" type="text/css" href="common.css"/>
    </head>
    <body>
		<div id="modal"></div>
		<div id="header">
			<a id="btunmatched" class="hidden">Unmathched</a>
			-
			<a class="btrefresh">Refresh <span class="refreshtime">0</span>ms</a>
			-
			<select id="sort">
				<option value="date" selected="selected">Date added</option>
				<option value="title">Title</option>
				<option value="rating">IMDB rating</option>
				<option value="duration">Duration</option>
				<option value="year">Year</option>
			</select>
			<input type="checkbox" id="descending" CHECKED/>
			<label for="descending">descending</label>
		</div>
		<div id="movieswrapper">
			<div id="movies"></div>
		</div>
		<img id="load" src="load.gif"/>
		
		<div id="templates">
			<div class="movieclassic movieroot">
				<img class="cover" />
				<div class="content">
					<h2></h2>
                    <p class="genres"></p>
					<p class="directors"></p>
                    <p class="principals"></p>
					<p class="plot"></p>
					<p class="actions">
						<a class="star" target="_blank"></a>
						<a class="allocine" target="_blank">Allociné</a>
						<a class="play">Play</a>
						<a class="showfiles"></a>
						<a class="delmatch">Delete match</a>
					</p>
					<p class="files hidden"></p>
				</div>
				<div class="clear"></div>
			</div>
			<div class="matcher">
				<div class="content">
					<a class="file"></a>
					<br/>
					<input type="text" name="q"/>
					-
					<a class="btignore">Add to ignore list</a>
					-
					<a class="btskip">Skip</a>
				</div>
				<div class="results"></div>
			</div>
			<div class="result">
				<a class="btok"></a>
				<b class="title"></b><br/>
				<span class="infos"></span>
			</div>
		</div>
        <script type="text/javascript">
            $(function () {
				$.fn.m = function(){
					var e = this;
					while(e.length){
						var d = e.data('m');
						if(d)return d;
						e = e.parent();
					}
				};
				
				var _data;
				var _jMovies = $('#movies');
				var _jModal = $('#modal');
				var _btUnmatched = $('#btunmatched');
				var _jTemplates = $('#templates');
				//Usefull to test/edit layout
				var _baseUrl = window.location.href.indexOf('file://') === 0
					? 'http://localhost:8080' : '';
				var _jSort = $('#sort');
				var _jDescending = $('#descending');
					
				var _srv = {
					call:function(action, params, cb){
						return $.getJSON(_baseUrl + '/*' + action + '?jsonp=?', params, cb);
					},
					play:function(f){
						return this.call('play', { f: f });
					},
					getData:function(cb){
						return this.call('movies', cb);
					},
					searchImdb:function(f, q, cb){
						return this.call('searchImdb', { f: f, q:q }, cb);
					},
					setMatch: function(f, id){
						return this.call('setMatch', {f:f || '', id:id || ''}, function(o){
							setData(o);
						});
					}
				};
					
				function showModal(v){
					_jModal.empty().append(v);
					if(!_jModal.is(':visible'))
						_jModal.slideDown(200);
				}
				
				function hideModal(){
					if(_jModal.is(':visible'))
						_jModal.slideUp(200);
				}
				
				function match(files, index){
					index = index || 0;
					if(files.length <= index){
						hideModal();
						return;
					}
					var f = files[index];
					var v = getTemplate('matcher');
					$('.btskip', v).click(function(){
						match(files, index+1);
					});
					
					$('.btignore', v).click(function(){
						//todo: add to ignore list
						match(files, index+1);
					});
					var xhr;
					var field = $('[name=q]', v);
					var search = function(f, q){
						if(xhr)
							xhr.abort();
						xhr = _srv.searchImdb(f, q, function(o){
							xhr = null;
							if(!field.val())
								field.val(o.Q);
							var div = $('.results', v).empty();
							var t = getTemplate('result');
							if(!o.Results.length)
								div.append($('<div/>').addClass('noresult').text('No result'));
							$.each(o.Results, function(k, r){
								var e = t.clone();
								$('.title', e).text(r.Title);
								$('.infos', e).text(r.Infos);
								e.click(function(){
									_srv.setMatch(f, r.ImdbId);
									match(files, index+1);
								});
								div.append(e);
							});
						});
					};
					
					$('.file', v).text(f).click(function(){_srv.play(f);});
					field.keypress(function(e){
						if((e.keyCode || e.which) != 13)
							return;
						search(f, field.val());
					});
					
					search(f);
					showModal(v);
				}
				
				function getTemplate(c){
					return $('.' + c, _jTemplates).clone();
				}
				
				var movieclassicTemplate = getTemplate('movieclassic');
				function makeMovieClassic(m){
					console.debug('makeMovieClassic');
					var e = movieclassicTemplate.clone().data('m', m);
					$('.cover', e).attr('src', _baseUrl + '/*cover/300x/' + (m.Cover || ''));
					$('h2', e).text(m.Title + (m.Year ? ' - ' + m.Year : ''));
					$('.genres', e).text(Math.round(m.Duration/60) + ' min - ' + m.Genres.join(' - '));
					$('.directors', e).text('By: ' + m.Directors.join(' - ')).toggle(!!m.Directors.length);
					$('.principals', e).text('With: ' + m.Principals.join(' - ')).toggle(!!m.Principals.length);
					$('.plot', e).text(m.Plot);
					$('.allocine', e).attr('href', 'http://www.google.fr/search?' + $.param({hl:'fr', btnI:'J\'ai de la chance', q:
						'site:allocine.fr/film ' + m.Title}));
					$('.star', e).text((m.ImdbRating || 'No rating')+ ' on IMDB').attr('href', 'http://imdb.com/title/' + m.ImdbId);
					$('.showfiles', e).text(m.Files.length + ' file' + (m.Files.length > 1 ? 's':''));
					return e;
				}
				
				function updateMovies(ms){
					var actuals = {};
					_jMovies.detach();
					
					_jMovies.children().each(function(){
						var e = $(this);
						var m = e.data('m');
						actuals[m.Hash] = e;
					}).detach();

					for(var i in ms){
						var m = ms[i];
						var e = actuals[m.Hash] || makeMovieClassic(m);
						_jMovies.append(e);
					}
					$('#movieswrapper').append(_jMovies);
				}
				
				function setData(data){
					_data = data;
					refresh();
				}
				
				function refresh(){
					var d1 = $.now();
					
					var sort = _jSort.val();
					var direction = _jDescending.is(':checked') ? -1 : 1;
					
					var movies = _data.Movies.sort(function(a, b){
						switch(sort){
							case 'title': return (a.Title.localeCompare(b.Title)) * direction;
							case 'rating': return (a.ImdbRating - b.ImdbRating) * direction;
							case 'duration': return (a.Duration - b.Duration) * direction;
							case 'year': return (a.Year - b.Year) * direction;
							default: return (Date.parse(a.DateAdded) - Date.parse(a.DateAdded)) * direction;
						}
					});
					
					updateMovies(movies);
					_btUnmatched
						.text(_data.Unmatched.length + ' unmatched')
						.toggle(_data.Unmatched.length ? true : false).unbind().click(function(){
							match(_data.Unmatched);
						});
					$('.refreshtime').text($.now() - d1);
				};
				
				//live events
				$('.showfiles', _jMovies).live('click', function () {
				    var e = $(this);
				    var div = $('.files', e.closest('.content'));
				    var files = e.m().Files;
				    if (div.is(':empty')) {
				        $.each(files, function (i, v) {
				            $('<a/>').addClass('file').text(v).click(function () {
				                _srv.play(v);
				            }).appendTo(div);
				        });
				    }
				    div.slideToggle(Math.min(500, files.length * 20));
				});

				$('.delmatch', _jMovies).live('click', function () {
					var e = $(this);
				    _srv.setMatch(null, e.m().ImdbId);
					e.closest('.movieroot').slideUp(200);
				});

				$('.play', _jMovies).live('click', function () {
					_srv.play($(this).m().Files[0]);
				});
				
				var reload = function(){
					_srv.getData(function (o) {
						setData(o);
					});
				};
				
				$('.btrefresh').click(refresh);
				
				reload();
                
				$('#load').ajaxStart(function() {
					$(this).show();
				}).ajaxStop(function() {
					$(this).hide();
				});
				
				_jSort.change(refresh);
				_jDescending.change(refresh);
            })
        </script>
    </body>
</html>
